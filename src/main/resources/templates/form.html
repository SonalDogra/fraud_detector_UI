<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Fraud Transaction Analyzer</title>
</head>
<body>
<h1>Enter Transaction Details</h1>

<form method="post" action="/analyze">
    <label>Consumer ID:</label><br>
    <input type="text" name="consumerId" required><br><br>

    <label>Amount (â‚¹):</label><br>
    <input type="number" name="amount" step="0.01" required><br><br>

    <label>Location:</label><br>
    <input type="text" name="location" required><br><br>

    <label>Transaction Hour (0â€“23):</label><br>
    <input type="number" name="hour" min="0" max="23" required><br><br>

    <label>Device ID:</label><br>
    <input type="text" name="deviceId" required><br><br>

    <label>Known Locations (comma-separated):</label><br>
    <input type="text" name="knownLocationsInput" required><br><br>

    <label>Known Devices (comma-separated):</label><br>
    <input type="text" name="knownDevicesInput" required><br><br>

    <label>Average Transaction Amount (â‚¹):</label><br>
    <input type="number" name="averageTransactionAmount" step="0.01" required><br><br>

    <label>Recent Flags (comma-separated):</label><br>
    <input type="text" name="recentFlagsInput"><br><br>

    <button type="submit">Analyze Transaction</button>
</form>

<!-- ðŸ§  Session Logging Script -->
<script>
    let typingTimestamps = [];
    let fingerprint = navigator.userAgent;

    document.querySelectorAll("input").forEach(input => {
        input.addEventListener("keydown", () => {
            typingTimestamps.push(Date.now());
        });
    });

    const calculateTypingInterval = () => {
        if (typingTimestamps.length < 2) return 0;
        let intervals = [];
        for (let i = 1; i < typingTimestamps.length; i++) {
            intervals.push(typingTimestamps[i] - typingTimestamps[i - 1]);
        }
        return Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
    };

    window.addEventListener("beforeunload", async () => {
        try {
            const sessionRes = await fetch("/get-session-id");
            const sessionData = await sessionRes.json();
            const sessionId = sessionData.sessionId;

            await fetch("https://fraud-detector-agent.onrender.com/log-session", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    session_id: sessionId,
                    data: {
                        typing_interval_ms: calculateTypingInterval(),
                        timezoneOffset: new Date().getTimezoneOffset(),
                        fingerprint: fingerprint
                    }
                })
            });
        } catch (e) {
            console.error("Session logging failed:", e);
        }
    });
</script>
</body>
</html>
